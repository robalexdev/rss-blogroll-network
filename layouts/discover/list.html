{{ define "extratitle" }}
<nav class="breadcrumb" aria-label="breadcrumbs">
  <ul>
    <li><a href="/">Home</a></li>
    <li class="is-active"><a href="#" aria-current="page">Feeds</a></li>
  </ul>
</nav>
{{ end }}

{{ define "main" }}

<h2 class="title is-3">Feeds</h2>

<div id="panel-filters" style="display: none;">
  <div class="block">
    <fieldset class="m-5" style="display: inline-block;">
      <legend class="label">Categories</legend>
      <div class="select is-multiple">
        <select multiple id="feed-cats"></select>
      </div>
    </fieldset>

    <fieldset class="m-5" style="display: inline-block;">
      <legend class="label">Feed Types</legend>
      <div class="select is-multiple">
        <select multiple id="feed-types"></select>
      </div>
    </fieldset>

    <fieldset class="m-5" style="display: inline-block;">
      <legend class="label">Languages</legend>
      <div class="select is-multiple">
        <select multiple id="feed-langs"></select>
      </div>
    </fieldset>
  </div>

  <i class="block">
    Tip: Ctrl-click or Command-click to select multiple filter values
  </i>
</div>

<p class="block">
  <div class="buttons">
    <button id="btn-toggle-filters" class="button is-primary" onclick="toggleFilterPanel();">Show Filters</button>
    <span>
    <span id="shown-feed-count">Loading...</span> {{ .Pages | len | lang.FormatNumberCustom 0 }} feeds shown
    </span>
  </div>
</p>

<table class="table mt-5 is-striped">
  <thead>
    <tr>
      <th></th>
      <th>
        Blog Name
      </th>
      <th>
        Description
      </th>
      <th style="max-width: 20em;">
        Categories
      </th>
    </tr>
  </thead>
  <tbody id="feed-table-body"></tbody>
</table>

<script>
  var filters = {
    types: new Set([]),
    categories: new Set([]),
    languages: new Set([]),
  };

  const feeds = [
    {{- range sort (sort .Pages ".Params.feedlink") ".Params.Score" "desc" -}}
    { "id": "{{ .Params.feedid }}",
      "title": 
        {{- if .Title -}}
          "{{ .Title | truncate 120 }}",
        {{- else -}}
          "{{ .Params.feedlink | truncate 120 }}",
        {{- end -}}
      "desc": "{{ .Params.description | truncate 120 }}",
      "cats": [
        {{- range (first 20 .Params.categories) -}}
          "{{ . | truncate 40 }}",
        {{- end -}}],
      "score": {{ .Params.Score }},
      "type": 
        {{- if .Params.ispodcast -}}
          "Podcast"
        {{- else if eq .Params.feedtype "rss" -}}
          "RSS feed"
        {{- else if eq .Params.feedtype "atom" -}}
          "Atom feed"
        {{- else -}}
          "Web feed"
        {{- end -}},
      "lang": 
        {{- if .Params.language -}}
          "{{ .Params.language }}",
        {{- else -}}
          "",
        {{- end -}}
    },
    {{- end -}}
  ];

  const langMap = {
    "af": ["Afrikaans", "Afrikaans"],
    "agq": ["Aghem", "Aghem"],
    "ak": ["Akan", "Akan"],
    "am": ["Amharic", "áŠ áˆ›áˆ­áŠ›"],
    "ar": ["Arabic", "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"],
    "as": ["Assamese", "à¦…à¦¸à¦®à§€à¦¯à¦¼à¦¾"],
    "asa": ["Asu", "Kipare"],
    "ast": ["Asturian", "asturianu"],
    "az": ["Azerbaijani", "azÉ™rbaycan"],
    "bas": ["Basaa", "ÆÃ sÃ a"],
    "be": ["Belarusian", "Ð±ÐµÐ»Ð°Ñ€ÑƒÑÐºÐ°Ñ"],
    "bem": ["Bemba", "Ichibemba"],
    "bez": ["Bena", "Hibena"],
    "bg": ["Bulgarian", "Ð±ÑŠÐ»Ð³Ð°Ñ€ÑÐºÐ¸"],
    "bgc": ["Haryanvi", "à¤¹à¤°à¤¿à¤¯à¤¾à¤£à¤µà¥€"],
    "bho": ["Bhojpuri", "à¤­à¥‹à¤œà¤ªà¥à¤°à¥€"],
    "bm": ["Bambara", "bamanakan"],
    "bn": ["Bangla", "à¦¬à¦¾à¦‚à¦²à¦¾"],
    "bo": ["Tibetan", "à½–à½¼à½‘à¼‹à½¦à¾à½‘à¼‹"],
    "br": ["Breton", "brezhoneg"],
    "brx": ["Bodo", "à¤¬à¤°â€™"],
    "bs": ["Bosnian", "bosanski"],
    "ca": ["Catalan", "catalÃ "],
    "ccp": ["Chakma", "ð‘„Œð‘„‹ð‘„´ð‘„Ÿð‘„³ð‘„¦"],
    "ce": ["Chechen", "Ð½Ð¾Ñ…Ñ‡Ð¸Ð¹Ð½"],
    "ceb": ["Cebuano", "Cebuano"],
    "cgg": ["Chiga", "Rukiga"],
    "chr": ["Cherokee", "á£áŽ³áŽ©"],
    "ckb": ["CentralKurdish", "Ú©ÙˆØ±Ø¯ÛŒÛŒÙ†Ø§ÙˆÛ•Ù†Ø¯ÛŒ"],
    "cs": ["Czech", "ÄeÅ¡tina"],
    "cv": ["Chuvash", "Ñ‡Ó‘Ð²Ð°Ñˆ"],
    "cy": ["Welsh", "Cymraeg"],
    "da": ["Danish", "dansk"],
    "dav": ["Taita", "Kitaita"],
    "de": ["German", "Deutsch"],
    "dje": ["Zarma", "Zarmaciine"],
    "doi": ["Dogri", "à¤¡à¥‹à¤—à¤°à¥€"],
    "dsb": ["LowerSorbian", "dolnoserbÅ¡Ä‡ina"],
    "dua": ["Duala", "duÃ¡lÃ¡"],
    "dz": ["Dzongkha", "à½¢à¾«à½¼à½„à¼‹à½"],
    "ebu": ["Embu", "KÄ©embu"],
    "ee": ["Ewe", "EÊ‹egbe"],
    "el": ["Greek", "Î•Î»Î»Î·Î½Î¹ÎºÎ¬"],
    "en": ["English", "English"],
    "eo": ["Esperanto", "Esperanto"],
    "es": ["Spanish", "EspaÃ±ol"],
    "et": ["Estonian", "eesti"],
    "eu": ["Basque", "euskara"],
    "ewo": ["Ewondo", "ewondo"],
    "fa": ["Persian", "ÙØ§Ø±Ø³ÛŒ"],
    "ff": ["Fula", "Pulaar"],
    "fi": ["Finnish", "suomi"],
    "fil": ["Filipino", "Filipino"],
    "fo": ["Faroese", "fÃ¸royskt"],
    "fr": ["French", "FranÃ§ais"],
    "fur": ["Friulian", "furlan"],
    "fy": ["WesternFrisian", "Frysk"],
    "ga": ["Irish", "Gaeilge"],
    "gd": ["ScottishGaelic", "GÃ idhlig"],
    "gl": ["Galician", "galego"],
    "gsw": ["SwissGerman", "SchwiizertÃ¼Ã¼tsch"],
    "gu": ["Gujarati", "àª—à«àªœàª°àª¾àª¤à«€"],
    "guz": ["Gusii", "Ekegusii"],
    "gv": ["Manx", "Gaelg"],
    "ha": ["Hausa", "Hausa"],
    "haw": ["Hawaiian", "Ê»ÅŒleloHawaiÊ»i"],
    "he": ["Hebrew", "×¢×‘×¨×™×ª"],
    "hi": ["Hindi", "à¤¹à¤¿à¤¨à¥à¤¦à¥€"],
    "hr": ["Croatian", "hrvatski"],
    "hsb": ["UpperSorbian", "hornjoserbÅ¡Ä‡ina"],
    "hu": ["Hungarian", "magyar"],
    "hy": ["Armenian", "Õ°Õ¡ÕµÕ¥Ö€Õ¥Õ¶"],
    "ia": ["Interlingua", "interlingua"],
    "id": ["Indonesian", "Indonesia"],
    "ig": ["Igbo", "Igbo"],
    "ii": ["SichuanYi", "ê†ˆêŒ ê‰™"],
    "is": ["Icelandic", "Ã­slenska"],
    "it": ["Italian", "Italiano"],
    "ja": ["Japanese", "æ—¥æœ¬èªž"],
    "jgo": ["Ngomba", "NdaêžŒa"],
    "jmc": ["Machame", "Kimachame"],
    "jv": ["Javanese", "Jawa"],
    "ka": ["Georgian", "áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜"],
    "kab": ["Kabyle", "Taqbaylit"],
    "kam": ["Kamba", "Kikamba"],
    "kde": ["Makonde", "Chimakonde"],
    "kea": ["Kabuverdianu", "kabuverdianu"],
    "kgp": ["Kaingang", "kanhgÃ¡g"],
    "khq": ["KoyraChiini", "Koyraciini"],
    "ki": ["Kikuyu", "Gikuyu"],
    "kk": ["Kazakh", "Ò›Ð°Ð·Ð°Ò›Ñ‚Ñ–Ð»Ñ–"],
    "kkj": ["Kako", "kakÉ”"],
    "kl": ["Kalaallisut", "kalaallisut"],
    "kln": ["Kalenjin", "Kalenjin"],
    "km": ["Khmer", "ážáŸ’áž˜áŸ‚ážš"],
    "kn": ["Kannada", "à²•à²¨à³à²¨à²¡"],
    "ko": ["Korean", "í•œêµ­ì–´"],
    "kok": ["Konkani", "à¤•à¥‹à¤‚à¤•à¤£à¥€"],
    "ks": ["Kashmiri", "Ú©Ù²Ø´ÙØ±"],
    "ksb": ["Shambala", "Kishambaa"],
    "ksf": ["Bafia", "rikpa"],
    "ksh": ["Colognian", "KÃ¶lsch"],
    "ku": ["Kurdish", "kurdÃ®"],
    "kw": ["Cornish", "kernewek"],
    "ky": ["Kyrgyz", "ÐºÑ‹Ñ€Ð³Ñ‹Ð·Ñ‡Ð°"],
    "lag": ["Langi", "KÉ¨laangi"],
    "lb": ["Luxembourgish", "LÃ«tzebuergesch"],
    "lg": ["Ganda", "Luganda"],
    "lkt": ["Lakota", "LakÈŸÃ³lÊ¼iyapi"],
    "ln": ["Lingala", "lingÃ¡la"],
    "lo": ["Lao", "àº¥àº²àº§"],
    "lrc": ["NorthernLuri", "Ù„ÛŠØ±ÛŒØ´ÙˆÙ…Ø§Ù„ÛŒ"],
    "lt": ["Lithuanian", "lietuviÅ³"],
    "luo": ["Luo", "Dholuo"],
    "luy": ["Luyia", "Luluhia"],
    "lv": ["Latvian", "latvieÅ¡u"],
    "mai": ["Maithili", "à¤®à¥ˆà¤¥à¤¿à¤²à¥€"],
    "mas": ["Masai", "Maa"],
    "mer": ["Meru", "KÄ©mÄ©rÅ©"],
    "mfe": ["Morisyen", "kreolmorisien"],
    "mg": ["Malagasy", "Malagasy"],
    "mgo": ["MetaÊ¼", "metaÊ¼"],
    "mi": ["MÄori", "MÄori"],
    "mk": ["Macedonian", "Ð¼Ð°ÐºÐµÐ´Ð¾Ð½ÑÐºÐ¸"],
    "ml": ["Malayalam", "à´®à´²à´¯à´¾à´³à´‚"],
    "mn": ["Mongolian", "Ð¼Ð¾Ð½Ð³Ð¾Ð»"],
    "mni": ["Manipuri", "à¦®à§ˆà¦¤à§ˆà¦²à§‹à¦¨à§"],
    "mr": ["Marathi", "à¤®à¤°à¤¾à¤ à¥€"],
    "ms": ["Malay", "Melayu"],
    "mt": ["Maltese", "Malti"],
    "mua": ["Mundang", "MUNDAÅŠ"],
    "my": ["Burmese", "á€™á€¼á€”á€ºá€™á€¬"],
    "mzn": ["Mazanderani", "Ù…Ø§Ø²Ø±ÙˆÙ†ÛŒ"],
    "naq": ["Nama", "Khoekhoegowab"],
    "nb": ["NorwegianBokmÃ¥l", "norskbokmÃ¥l"],
    "nd": ["NorthNdebele", "isiNdebele"],
    "ne": ["Nepali", "à¤¨à¥‡à¤ªà¤¾à¤²à¥€"],
    "nl": ["Dutch", "Nederlands"],
    "nmg": ["Kwasio", "Kwasio"],
    "nn": ["NorwegianNynorsk", "norsknynorsk"],
    "nnh": ["Ngiemboon", "ShwÃ³Å‹Ã²ngiembÉ”É”n"],
    "no": ["Norwegian", "norsk"],
    "nus": ["Nuer", "ThokNath"],
    "nyn": ["Nyankole", "Runyankore"],
    "om": ["Oromo", "Oromoo"],
    "or": ["Odia", "à¬“à¬¡à¬¼à¬¿à¬†"],
    "os": ["Ossetic", "Ð¸Ñ€Ð¾Ð½"],
    "pa": ["Punjabi", "à¨ªà©°à¨œà¨¾à¨¬à©€"],
    "pcm": ["NigerianPidgin", "NaijÃ­riÃ¡PÃ­jin"],
    "pl": ["Polish", "polski"],
    "ps": ["Pashto", "Ù¾ÚšØªÙˆ"],
    "pt": ["Portuguese", "PortuguÃªs"],
    "qu": ["Quechua", "Runasimi"],
    "raj": ["Rajasthani", "à¤°à¤¾à¤œà¤¸à¥à¤¥à¤¾à¤¨à¥€"],
    "rm": ["Romansh", "rumantsch"],
    "rn": ["Rundi", "Ikirundi"],
    "ro": ["Romanian", "romÃ¢nÄƒ"],
    "rof": ["Rombo", "Kihorombo"],
    "ru": ["Russian", "Ñ€ÑƒÑÑÐºÐ¸Ð¹"],
    "rw": ["Kinyarwanda", "Kinyarwanda"],
    "rwk": ["Rwa", "Kiruwa"],
    "sa": ["Sanskrit", "à¤¸à¤‚à¤¸à¥à¤•à¥ƒà¤¤à¤­à¤¾à¤·à¤¾"],
    "sah": ["Yakut", "ÑÐ°Ñ…Ð°Ñ‚Ñ‹Ð»Ð°"],
    "saq": ["Samburu", "Kisampur"],
    "sat": ["Santali", "á±¥á±Ÿá±±á±›á±Ÿá±²á±¤"],
    "sbp": ["Sangu", "Ishisangu"],
    "sc": ["Sardinian", "sardu"],
    "sd": ["Sindhi", "Ø³Ù†ÚŒÙŠ"],
    "se": ["NorthernSami", "davvisÃ¡megiella"],
    "seh": ["Sena", "sena"],
    "ses": ["KoyraboroSenni", "Koyraborosenni"],
    "sg": ["Sango", "SÃ¤ngÃ¶"],
    "shi": ["Tachelhit", "âµœâ´°âµ›âµâµƒâµ‰âµœ"],
    "si": ["Sinhala", "à·ƒà·’à¶‚à·„à¶½"],
    "sk": ["Slovak", "slovenÄina"],
    "sl": ["Slovenian", "slovenÅ¡Äina"],
    "smn": ["InariSami", "anarÃ¢Å¡kielÃ¢"],
    "sn": ["Shona", "chiShona"],
    "so": ["Somali", "Soomaali"],
    "sq": ["Albanian", "shqip"],
    "sr": ["Serbian", "ÑÑ€Ð¿ÑÐºÐ¸"],
    "su": ["Sundanese", "BasaSunda"],
    "sv": ["Swedish", "Svenska"],
    "sw": ["Swahili", "Kiswahili"],
    "ta": ["Tamil", "à®¤à®®à®¿à®´à¯"],
    "te": ["Telugu", "à°¤à±†à°²à±à°—à±"],
    "teo": ["Teso", "Kiteso"],
    "tg": ["Tajik", "Ñ‚Ð¾Ò·Ð¸ÐºÓ£"],
    "th": ["Thai", "à¹„à¸—à¸¢"],
    "ti": ["Tigrinya", "á‰µáŒáˆ­áŠ›"],
    "tk": ["Turkmen", "tÃ¼rkmendili"],
    "to": ["Tongan", "leafakatonga"],
    "tr": ["Turkish", "TÃ¼rkÃ§e"],
    "tt": ["Tatar", "Ñ‚Ð°Ñ‚Ð°Ñ€"],
    "twq": ["Tasawaq", "Tasawaqsenni"],
    "tzm": ["CentralAtlasTamazight", "TamaziÉ£tnlaá¹­laá¹£"],
    "ug": ["Uyghur", "Ø¦Û‡ÙŠØºÛ‡Ø±Ú†Û•"],
    "uk": ["Ukrainian", "ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°"],
    "ur": ["Urdu", "Ø§Ø±Ø¯Ùˆ"],
    "uz": ["Uzbek", "oâ€˜zbek"],
    "vai": ["Vai", "ê•™ê”¤"],
    "vi": ["Vietnamese", "Tiáº¿ngViá»‡t"],
    "vun": ["Vunjo", "Kyivunjo"],
    "wae": ["Walser", "Walser"],
    "wo": ["Wolof", "Wolof"],
    "xh": ["Xhosa", "IsiXhosa"],
    "xog": ["Soga", "Olusoga"],
    "yav": ["Yangben", "nuasue"],
    "yi": ["Yiddish", "×™×™Ö´×“×™×©"],
    "yo": ["Yoruba", "ÃˆdÃ¨YorÃ¹bÃ¡"],
    "yrl": ["Nheengatu", "nheáº½gatu"],
    "yue": ["Cantonese", "ç²µèªž"],
    "zgh": ["StandardMoroccanTamazight", "âµœâ´°âµŽâ´°âµ£âµ‰âµ–âµœ"],
    "zh": ["Chinese", "ä¸­æ–‡"],
    "zu": ["Zulu", "isiZulu"],
  };

  const UNSPECIFIFIED_LANGUAGE = "";
  const userLanguages = new Set(navigator.languages.map((code) => code.split("-")[0]));
  const feedElmId = (id) => `feed-${id}`;
  const nullRename = (name) => ["", name];
  const langRename = (lang) => {
    if (lang in langMap) {
      return langMap[lang];
    } else if (lang === UNSPECIFIFIED_LANGUAGE) {
      return ["", "(unspecified)"];
    }
    return ["", lang];
  };
  const isUserLanguage = (lang) => {
    return userLanguages.has(lang) || lang === UNSPECIFIFIED_LANGUAGE;
  };

  var render_table = () => {
    const tbody = document.getElementById("feed-table-body");

    feeds.forEach(feed => {
      var row = document.createElement("tr");
      row.id = feedElmId(feed.id);

      var cell = document.createElement("td");
      var tag = document.createElement("span");
      if (feed.type == "Podcast") {
        tag.className = "tag is-warning is-light";
      } else {
        tag.className = "tag is-info is-light";
      }
      tag.innerText = feed.type;
      cell.appendChild(tag);
      row.appendChild(cell);

      cell = document.createElement("td");
      var link = document.createElement("a");
      link.innerText = feed.title;
      link.href = `/discover/feed-${feed.id}/`;
      cell.appendChild(link);
      row.appendChild(cell);

      cell = document.createElement("td");
      cell.innerText = feed.desc;
      row.appendChild(cell);

      cell = document.createElement("td");
      feed.cats.forEach(cat => {
        var tag = document.createElement("span");
        tag.classList = "tag m-1";
        tag.innerText = cat;
        cell.appendChild(tag);
      });
      row.appendChild(cell);
      tbody.appendChild(row);
    });
  };

  const on_filter_select_change = (elmId, filter) => {
    const target = document.getElementById(elmId);
    for (var i = 0; i < target.length; i++) {
      const opt = target[i];
      const v = opt.value;
      if (opt.selected) {
        filter.add(v);
      } else {
        filter.delete(v);
      }
    };
    on_filter_change();
  }

  const render_filter = (targetId, values, filterSet, rename=nullRename, isDefault=(a)=>false) => {
    const target = document.getElementById(targetId);
    target.onchange=() => {
      on_filter_select_change(targetId, filterSet);
    };

    // Sort the values by occurances
    var valCounter = {};
    values.forEach((v) => {
      const sortKey = v.toLowerCase();
      if (!(sortKey in valCounter)) {
        valCounter[sortKey] = {
          count: 0,
          canonicalV: v,
        };
      }
      valCounter[sortKey].count += 1;
      if (v > valCounter[sortKey].canonicalV) {
        valCounter[sortKey].canonicalV = v;
      }
    });
    const sortedValues = Object.keys(valCounter).sort((a, b) => {
      return valCounter[b].count - valCounter[a].count;
    });

    sortedValues.forEach(v => {
      var opt = document.createElement("option");
      opt.value = v;

      if (isDefault(v)) {
        opt.selected = true;
        filterSet.add(v);
      } else {
        opt.selected = false;
      }

      var fullName, titleName;
      [titleName, fullName] = rename(valCounter[v].canonicalV);
      opt.innerText = fullName;
      opt.title = titleName;
      target.appendChild(opt);
    });
  };

  const render_langs = () => {
    const langs = feeds.map((feed) => feed.lang);
    render_filter("feed-langs", langs, filters.languages, rename=langRename, isDefault=isUserLanguage);
  };

  const render_type_filter = () => {
    const types = feeds.map((feed) => feed.type);
    render_filter("feed-types", types, filters.types);
  };

  const render_cat_filter = () => {
    const cats = [];
    feeds.forEach((feed) => {
      feed.cats.forEach((cat) => {
        // Filter out some noise
        if (cat.length > 3) {
          cats.push(cat);
        }
      });
    });
    render_filter("feed-cats", cats, filters.categories);
  };

  const shouldShowFeed = (feed) => {
    if (filters.types.size > 0 && !filters.types.has(feed.type.toLowerCase())) {
      return false;
    }
    if (filters.languages.size > 0 && !filters.languages.has(feed.lang.toLowerCase())) {
      return false;
    }
    if (filters.categories.size > 0 && !feed.cats.some((cat) => filters.categories.has(cat.toLowerCase()))) {
      return false;
    }
    return true;
  };

  const on_filter_change = () => {
    var shownCount = 0;
    feeds.forEach(feed => {
      var e = document.getElementById(feedElmId(feed.id));
      if (shouldShowFeed(feed)) {
        shownCount += 1;
        e.style.display = "";
      } else {
        e.style.display = "none";
      }
    });
    var e = document.getElementById("shown-feed-count");
    if (shownCount == feeds.length) {
      e.innerText = "All"
    } else {
      e.innerText = shownCount.toLocaleString() + " of";
    }
  }

  const toggleFilterPanel = () => {
    const panel = document.getElementById("panel-filters");
    const button = document.getElementById("btn-toggle-filters");
    button.innerText = (panel.style.display === "") ? "Show Filters" : "Hide Filters";
    panel.style.display = (panel.style.display === "") ? "none" : "";
  };

  (function() {
    render_type_filter();
    render_langs();
    render_cat_filter();
    render_table();
    on_filter_change();
  })();
</script>

{{- end -}}
